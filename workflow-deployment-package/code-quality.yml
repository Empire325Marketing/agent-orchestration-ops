
name: ðŸ“Š Code Quality & Linting

on:
  push:
    branches: [ main, ops-readiness, develop ]
  pull_request:
    branches: [ main, ops-readiness ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  python-quality:
    name: ðŸ Python Code Quality
    runs-on: ubuntu-latest
    if: hashFiles('**/*.py') != ''
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy bandit pylint autopep8 pydocstyle
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: ðŸŽ¨ Code Formatting (Black)
        run: |
          echo "ðŸŽ¨ Checking code formatting with Black..."
          black --check --diff --color .
          echo "âœ… Black formatting check completed"

      - name: ðŸ“‹ Import Sorting (isort)
        run: |
          echo "ðŸ“‹ Checking import sorting with isort..."
          isort --check-only --diff --color .
          echo "âœ… isort check completed"

      - name: ðŸ” Linting (Flake8)
        run: |
          echo "ðŸ” Running Flake8 linting..."
          flake8 . --count --statistics --format=json --output-file=flake8-report.json || true
          flake8 . --count --statistics
          echo "âœ… Flake8 linting completed"

      - name: ðŸ·ï¸ Type Checking (MyPy)
        run: |
          echo "ðŸ·ï¸ Running MyPy type checking..."
          mypy . --ignore-missing-imports --json-report mypy-report || true
          echo "âœ… MyPy type checking completed"

      - name: ðŸ”’ Security Linting (Bandit)
        run: |
          echo "ðŸ”’ Running Bandit security linting..."
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt || true
          echo "âœ… Bandit security linting completed"

      - name: ðŸ“Š Code Quality (Pylint)
        run: |
          echo "ðŸ“Š Running Pylint code quality analysis..."
          pylint **/*.py --output-format=json --reports=y > pylint-report.json || true
          pylint **/*.py --reports=y || true
          echo "âœ… Pylint analysis completed"

      - name: ðŸ“ Documentation Style (pydocstyle)
        run: |
          echo "ðŸ“ Checking documentation style..."
          pydocstyle . --count || true
          echo "âœ… Documentation style check completed"

      - name: ðŸ“¤ Upload Python Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: python-quality-reports
          path: |
            flake8-report.json
            mypy-report/
            bandit-report.json
            pylint-report.json
          retention-days: 30

  javascript-quality:
    name: ðŸ“¦ JavaScript Code Quality
    runs-on: ubuntu-latest
    if: hashFiles('**/*.js', '**/*.ts', '**/*.jsx', '**/*.tsx', '**/package.json') != ''
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            npm install -g eslint prettier jshint
          fi

      - name: ðŸŽ¨ Code Formatting (Prettier)
        run: |
          echo "ðŸŽ¨ Checking code formatting with Prettier..."
          if [ -f package.json ] && npm list prettier &>/dev/null; then
            npx prettier --check .
          else
            echo "â„¹ï¸ Prettier not configured"
          fi
          echo "âœ… Prettier check completed"

      - name: ðŸ” Linting (ESLint)
        run: |
          echo "ðŸ” Running ESLint..."
          if [ -f package.json ] && npm list eslint &>/dev/null; then
            npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-report.json || true
            npx eslint . --ext .js,.jsx,.ts,.tsx || true
          else
            echo "â„¹ï¸ ESLint not configured"
          fi
          echo "âœ… ESLint completed"

      - name: ðŸ“Š Code Quality (JSHint)
        run: |
          echo "ðŸ“Š Running JSHint..."
          find . -name "*.js" -not -path "./node_modules/*" -exec jshint {} \; || true
          echo "âœ… JSHint completed"

      - name: ðŸ“¤ Upload JavaScript Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: javascript-quality-reports
          path: |
            eslint-report.json
          retention-days: 30

  shell-quality:
    name: ðŸš Shell Script Quality
    runs-on: ubuntu-latest
    if: hashFiles('**/*.sh', '**/*.bash') != ''
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” ShellCheck Linting
        run: |
          echo "ðŸ” Running ShellCheck..."
          sudo apt-get update && sudo apt-get install -y shellcheck
          
          # Find and check all shell scripts
          find . -name "*.sh" -o -name "*.bash" | while read -r script; do
            echo "ðŸ” Checking $script..."
            shellcheck "$script" -f json > "shellcheck-$(basename "$script").json" || true
            shellcheck "$script" || true
          done
          
          echo "âœ… ShellCheck completed"

      - name: ðŸ“¤ Upload Shell Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: shell-quality-reports
          path: |
            shellcheck-*.json
          retention-days: 30

  yaml-quality:
    name: ðŸ“„ YAML Quality
    runs-on: ubuntu-latest
    if: hashFiles('**/*.yml', '**/*.yaml') != ''
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install yamllint
        run: |
          pip install yamllint

      - name: ðŸ” YAML Linting
        run: |
          echo "ðŸ” Running yamllint..."
          yamllint . -f parsable > yamllint-report.txt || true
          yamllint . || true
          echo "âœ… yamllint completed"

      - name: ðŸ“¤ Upload YAML Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: yaml-quality-reports
          path: |
            yamllint-report.txt
          retention-days: 30

  markdown-quality:
    name: ðŸ“ Markdown Quality
    runs-on: ubuntu-latest
    if: hashFiles('**/*.md') != ''
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install markdownlint
        run: |
          npm install -g markdownlint-cli

      - name: ðŸ” Markdown Linting
        run: |
          echo "ðŸ” Running markdownlint..."
          markdownlint . --json > markdownlint-report.json || true
          markdownlint . || true
          echo "âœ… markdownlint completed"

      - name: ðŸ“¤ Upload Markdown Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: markdown-quality-reports
          path: |
            markdownlint-report.json
          retention-days: 30

  dockerfile-quality:
    name: ðŸ³ Dockerfile Quality
    runs-on: ubuntu-latest
    if: hashFiles('**/Dockerfile*') != ''
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Hadolint Dockerfile Linting
        run: |
          echo "ðŸ” Running Hadolint..."
          wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x hadolint
          
          find . -name "Dockerfile*" | while read -r dockerfile; do
            echo "ðŸ” Checking $dockerfile..."
            ./hadolint "$dockerfile" --format json > "hadolint-$(basename "$dockerfile").json" || true
            ./hadolint "$dockerfile" || true
          done
          
          echo "âœ… Hadolint completed"

      - name: ðŸ“¤ Upload Dockerfile Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dockerfile-quality-reports
          path: |
            hadolint-*.json
          retention-days: 30

  quality-summary:
    name: ðŸ“Š Quality Summary Report
    runs-on: ubuntu-latest
    needs: [python-quality, javascript-quality, shell-quality, yaml-quality, markdown-quality, dockerfile-quality]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download All Quality Reports
        uses: actions/download-artifact@v3
        with:
          path: quality-reports/

      - name: ðŸ“Š Generate Quality Summary
        run: |
          echo "ðŸ“Š Generating code quality summary..."
          
          cat > quality-summary.md << EOF
          # ðŸ“Š Code Quality Report
          
          **Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ## ðŸ“‹ Quality Check Results
          
          | Language/Tool | Status | Details |
          |---------------|--------|---------|
          | ðŸ Python | ${{ needs.python-quality.result }} | Black, isort, Flake8, MyPy, Bandit, Pylint |
          | ðŸ“¦ JavaScript | ${{ needs.javascript-quality.result }} | Prettier, ESLint, JSHint |
          | ðŸš Shell Scripts | ${{ needs.shell-quality.result }} | ShellCheck |
          | ðŸ“„ YAML | ${{ needs.yaml-quality.result }} | yamllint |
          | ðŸ“ Markdown | ${{ needs.markdown-quality.result }} | markdownlint |
          | ðŸ³ Dockerfile | ${{ needs.dockerfile-quality.result }} | Hadolint |
          
          ## ðŸŽ¯ Quality Metrics
          
          ### ðŸ Python Quality
          - **Formatting:** $([ "${{ needs.python-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          - **Type Checking:** $([ "${{ needs.python-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          - **Security:** $([ "${{ needs.python-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          
          ### ðŸ“¦ JavaScript Quality
          - **Formatting:** $([ "${{ needs.javascript-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          - **Linting:** $([ "${{ needs.javascript-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          
          ### ðŸš Shell Quality
          - **ShellCheck:** $([ "${{ needs.shell-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          
          ### ðŸ“„ Configuration Quality
          - **YAML:** $([ "${{ needs.yaml-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          - **Markdown:** $([ "${{ needs.markdown-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          - **Dockerfile:** $([ "${{ needs.dockerfile-quality.result }}" == "success" ] && echo "âœ… Passed" || echo "âŒ Issues found")
          
          ## ðŸš€ Recommendations
          
          $(if [ "${{ needs.python-quality.result }}" != "success" ]; then
            echo "### ðŸ Python Improvements"
            echo "- Run \`black .\` to fix formatting issues"
            echo "- Run \`isort .\` to fix import sorting"
            echo "- Address Flake8 linting issues"
            echo "- Fix MyPy type checking errors"
            echo "- Review Bandit security warnings"
            echo ""
          fi)
          
          $(if [ "${{ needs.javascript-quality.result }}" != "success" ]; then
            echo "### ðŸ“¦ JavaScript Improvements"
            echo "- Run \`prettier --write .\` to fix formatting"
            echo "- Address ESLint warnings and errors"
            echo "- Fix JSHint issues"
            echo ""
          fi)
          
          $(if [ "${{ needs.shell-quality.result }}" != "success" ]; then
            echo "### ðŸš Shell Script Improvements"
            echo "- Address ShellCheck warnings"
            echo "- Follow shell scripting best practices"
            echo ""
          fi)
          
          ## ðŸ“ˆ Quality Trends
          
          - **Overall Status:** $(if [[ "${{ needs.python-quality.result }}" == "success" && "${{ needs.javascript-quality.result }}" == "success" && "${{ needs.shell-quality.result }}" == "success" && "${{ needs.yaml-quality.result }}" == "success" && "${{ needs.markdown-quality.result }}" == "success" && "${{ needs.dockerfile-quality.result }}" == "success" ]]; then echo "ðŸŸ¢ Excellent"; elif [[ "${{ needs.python-quality.result }}" == "success" || "${{ needs.javascript-quality.result }}" == "success" ]]; then echo "ðŸŸ¡ Good"; else echo "ðŸ”´ Needs Improvement"; fi)
          - **Code Coverage:** TBD (integrate with coverage tools)
          - **Technical Debt:** TBD (integrate with SonarQube or similar)
          
          ---
          
          *Report generated automatically by GitHub Actions*
          EOF
          
          echo "âœ… Quality summary generated"

      - name: ðŸ“¤ Upload Quality Summary
        uses: actions/upload-artifact@v3
        with:
          name: quality-summary-report
          path: |
            quality-summary.md
            quality-reports/
          retention-days: 30

      - name: ðŸ“¢ Quality Status
        run: |
          echo "ðŸ“¢ Code Quality Summary:"
          echo "ðŸ Python: ${{ needs.python-quality.result }}"
          echo "ðŸ“¦ JavaScript: ${{ needs.javascript-quality.result }}"
          echo "ðŸš Shell: ${{ needs.shell-quality.result }}"
          echo "ðŸ“„ YAML: ${{ needs.yaml-quality.result }}"
          echo "ðŸ“ Markdown: ${{ needs.markdown-quality.result }}"
          echo "ðŸ³ Dockerfile: ${{ needs.dockerfile-quality.result }}"
